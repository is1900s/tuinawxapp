<!-- åœ°å€é€‰æ‹©ç»„ä»¶ -->
<view class="address-selector">
  <!-- ç»„ä»¶æ ‡é¢˜ -->
  <view class="selector-header" wx:if="{{showHeader}}">
    <text class="selector-title">{{title}}</text>
    <text class="selector-subtitle" wx:if="{{subtitle}}">{{subtitle}}</text>
  </view>

  <!-- åœ°å€åˆ—è¡¨ -->
  <scroll-view class="address-scroll" scroll-y="true" style="height: {{scrollHeight}}">
    <view class="address-list">
      <!-- å½“å‰ä½ç½® -->
      <view class="current-location" bindtap="onCurrentLocationTap">
        <view class="location-icon">ğŸ“</view>
        <view class="location-info">
          <text class="location-title">å½“å‰ä½ç½®</text>
          <text class="location-desc">{{currentLocation.address || 'æ­£åœ¨è·å–ä½ç½®ä¿¡æ¯...'}}</text>
        </view>
        <view class="location-status {{locationLoading ? 'loading' : ''}}">
          <text class="status-text">{{locationLoading ? 'å®šä½ä¸­...' : 'ä½¿ç”¨æ­¤ä½ç½®'}}</text>
        </view>
      </view>

      <!-- å·²ä¿å­˜åœ°å€ -->
      <view class="saved-addresses" wx:if="{{addressList.length > 0}}">
        <view class="section-header">
          <text class="section-title">å·²ä¿å­˜åœ°å€</text>
          <text class="section-action" bindtap="onAddNewAddress" wx:if="{{allowAddNew}}">
            <text class="action-icon">+</text>
            <text class="action-text">æ–°å¢åœ°å€</text>
          </text>
        </view>

        <view
          class="address-item {{selectedAddress.id === item.id ? 'selected' : ''}}"
          wx:for="{{addressList}}"
          wx:key="id"
          bindtap="onAddressSelect"
          data-address="{{item}}"
        >
          <view class="address-content">
            <!-- åœ°å€ä¿¡æ¯ -->
            <view class="address-info">
              <view class="address-header">
                <text class="address-name">{{item.name}}</text>
                <text class="address-phone">{{item.phone}}</text>
                <view class="address-tags">
                  <text class="tag tag-default" wx:if="{{item.isDefault}}">é»˜è®¤</text>
                  <text class="tag tag-home" wx:if="{{item.type === 'home'}}">å®¶</text>
                  <text class="tag tag-company" wx:if="{{item.type === 'company'}}">å…¬å¸</text>
                </view>
              </view>
              <text class="address-detail">{{item.fullAddress}}</text>
              <view class="address-note" wx:if="{{item.note}}">
                <text class="note-icon">ğŸ“</text>
                <text class="note-text">{{item.note}}</text>
              </view>
            </view>

            <!-- è·ç¦»ä¿¡æ¯ï¼ˆå¦‚æœæä¾›ï¼‰ -->
            <view class="distance-info" wx:if="{{item.distance}}">
              <text class="distance">{{item.distance}}km</text>
            </view>
          </view>

          <!-- æ“ä½œæŒ‰é’® -->
          <view class="address-actions">
            <view
              class="action-btn edit-btn"
              bindtap="onEditAddress"
              data-address="{{item}}"
              wx:if="{{allowEdit}}"
            >
              <text class="action-icon">âœï¸</text>
            </view>
            <view
              class="action-btn delete-btn"
              bindtap="onDeleteAddress"
              data-address="{{item}}"
              wx:if="{{allowDelete}}"
            >
              <text class="action-icon">ğŸ—‘ï¸</text>
            </view>
          </view>

          <!-- é€‰ä¸­æŒ‡ç¤ºå™¨ -->
          <view class="select-indicator" wx:if="{{selectedAddress.id === item.id}}">
            <text class="indicator-icon">âœ“</text>
          </view>
        </view>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:if="{{addressList.length === 0 && !locationLoading}}">
        <text class="empty-icon">ğŸ“</text>
        <text class="empty-title">æš‚æ— ä¿å­˜çš„åœ°å€</text>
        <text class="empty-desc">æ·»åŠ å¸¸ç”¨åœ°å€ï¼Œæ–¹ä¾¿å¿«é€Ÿé€‰æ‹©</text>
        <button class="btn btn-primary" bindtap="onAddNewAddress" wx:if="{{allowAddNew}}">
          æ·»åŠ æ–°åœ°å€
        </button>
      </view>
    </view>
  </scroll-view>

  <!-- å¿«é€Ÿé€‰æ‹©ï¼ˆç´§å‡‘æ¨¡å¼ï¼‰ -->
  <view class="quick-select" wx:if="{{quickMode && addressList.length > 0}}">
    <view class="quick-options">
      <view
        class="quick-option {{selectedAddress.id === item.id ? 'selected' : ''}}"
        wx:for="{{addressList.slice(0, 3)}}"
        wx:key="id"
        bindtap="onAddressSelect"
        data-address="{{item}}"
      >
        <text class="quick-icon">{{item.type === 'home' ? 'ğŸ ' : item.type === 'company' ? 'ğŸ¢' : 'ğŸ“'}}</text>
        <text class="quick-name">{{item.name}}</text>
      </view>
    </view>
  </view>

  <!-- æ“ä½œæŒ‰é’® -->
  <view class="action-buttons" wx:if="{{showActions && !quickMode}}">
    <button class="btn btn-outline" bindtap="onCancel" wx:if="{{showCancel}}">å–æ¶ˆ</button>
    <button
      class="btn btn-primary"
      bindtap="onConfirm"
      disabled="{{!selectedAddress.id && !currentLocation.address}}"
    >ç¡®è®¤é€‰æ‹©</button>
  </view>

  <!-- é€‰ä¸­åœ°å€ä¿¡æ¯å±•ç¤º -->
  <view class="selected-address-info" wx:if="{{showSelectedInfo && (selectedAddress.id || currentLocation.address)}}" bindtap="onReselect">
    <view class="selected-header">
      <text class="selected-title">æœåŠ¡åœ°å€</text>
      <text class="selected-change">ä¿®æ”¹</text>
    </view>
    <view class="selected-details">
      <view class="selected-icon">ğŸ“</view>
      <view class="selected-info">
        <text class="selected-name">
          {{selectedAddress.name || 'å½“å‰ä½ç½®'}}
          <text class="selected-phone" wx:if="{{selectedAddress.phone}}">{{selectedAddress.phone}}</text>
        </text>
        <text class="selected-address">{{selectedAddress.fullAddress || currentLocation.address}}</text>
      </view>
    </view>
  </view>
</view>

<!-- åœ°å€ç¼–è¾‘å¼¹çª— -->
<view class="address-edit-modal {{showEditModal ? 'show' : ''}}" bindtap="onEditModalClose">
  <view class="edit-content" catchtap="onEditModalContentTap">
    <view class="edit-header">
      <text class="edit-title">{{editMode === 'add' ? 'æ·»åŠ åœ°å€' : 'ç¼–è¾‘åœ°å€'}}</text>
      <text class="edit-close" bindtap="onEditModalClose">Ã—</text>
    </view>

    <view class="edit-form">
      <!-- åœ°å€ç±»å‹ -->
      <view class="form-group">
        <text class="form-label">åœ°å€ç±»å‹</text>
        <radio-group class="type-selector" bindchange="onTypeChange">
          <label class="type-option">
            <radio value="home" checked="{{editForm.type === 'home'}}" />
            <text class="type-text">å®¶</text>
          </label>
          <label class="type-option">
            <radio value="company" checked="{{editForm.type === 'company'}}" />
            <text class="type-text">å…¬å¸</text>
          </label>
          <label class="type-option">
            <radio value="other" checked="{{editForm.type === 'other'}}" />
            <text class="type-text">å…¶ä»–</text>
          </label>
        </radio-group>
      </view>

      <!-- è”ç³»äºº -->
      <view class="form-group">
        <text class="form-label">è”ç³»äºº</text>
        <input
          class="form-input"
          type="text"
          placeholder="è¯·è¾“å…¥è”ç³»äººå§“å"
          value="{{editForm.name}}"
          bindinput="onNameInput"
          maxlength="20"
        />
      </view>

      <!-- ç”µè¯å·ç  -->
      <view class="form-group">
        <text class="form-label">ç”µè¯å·ç </text>
        <input
          class="form-input"
          type="number"
          placeholder="è¯·è¾“å…¥ç”µè¯å·ç "
          value="{{editForm.phone}}"
          bindinput="onPhoneInput"
          maxlength="11"
        />
      </view>

      <!-- åœ°åŒºé€‰æ‹© -->
      <view class="form-group">
        <text class="form-label">æ‰€åœ¨åœ°åŒº</text>
        <picker
          mode="region"
          value="{{editForm.region}}"
          bindchange="onRegionChange"
        >
          <view class="picker-view">
            <text class="picker-text">{{editForm.region.join('') || 'è¯·é€‰æ‹©çœå¸‚åŒº'}}</text>
            <text class="picker-arrow">â–¼</text>
          </view>
        </picker>
      </view>

      <!-- è¯¦ç»†åœ°å€ -->
      <view class="form-group">
        <text class="form-label">è¯¦ç»†åœ°å€</text>
        <textarea
          class="form-textarea"
          placeholder="è¯·è¾“å…¥è¯¦ç»†åœ°å€ï¼ˆè¡—é“ã€é—¨ç‰Œå·ç­‰ï¼‰"
          value="{{editForm.detailAddress}}"
          bindinput="onDetailAddressInput"
          maxlength="100"
        />
      </view>

      <!-- å¤‡æ³¨ -->
      <view class="form-group">
        <text class="form-label">å¤‡æ³¨ä¿¡æ¯</text>
        <textarea
          class="form-textarea"
          placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯ï¼ˆé€‰å¡«ï¼‰"
          value="{{editForm.note}}"
          bindinput="onNoteInput"
          maxlength="50"
        />
      </view>

      <!-- è®¾ä¸ºé»˜è®¤ -->
      <view class="form-group">
        <checkbox-group bindchange="onDefaultChange">
          <label class="checkbox-label">
            <checkbox value="default" checked="{{editForm.isDefault}}" />
            <text class="checkbox-text">è®¾ä¸ºé»˜è®¤åœ°å€</text>
          </label>
        </checkbox-group>
      </view>
    </view>

    <view class="edit-footer">
      <button class="btn btn-outline" bindtap="onEditModalClose">å–æ¶ˆ</button>
      <button class="btn btn-primary" bindtap="onSaveAddress">ä¿å­˜</button>
    </view>
  </view>
</view>

<!-- åœ°å›¾é€‰æ‹©æ¨¡å¼ -->
<view class="map-selector" wx:if="{{showMapSelector}}">
  <view class="map-header">
    <text class="map-title">åœ¨åœ°å›¾ä¸Šé€‰æ‹©ä½ç½®</text>
    <text class="map-close" bindtap="onMapSelectorClose">Ã—</text>
  </view>

  <!-- åœ°å›¾å®¹å™¨ -->
  <map
    class="map-container"
    latitude="{{mapCenter.latitude}}"
    longitude="{{mapCenter.longitude}}"
    scale="16"
    show-location="{{true}}"
    bindtap="onMapTap"
    bindmarkertap="onMarkerTap"
  >
    <!-- å½“å‰ä½ç½®æ ‡è®° -->
    <cover-view class="current-marker" wx:if="{{selectedLocation}}">
      <cover-view class="marker-icon">ğŸ“</cover-view>
    </cover-view>
  </map>

  <!-- åœ°å€ä¿¡æ¯ -->
  <view class="map-address-info" wx:if="{{selectedLocation.address}}">
    <text class="map-address">{{selectedLocation.address}}</text>
  </view>

  <!-- ç¡®è®¤æŒ‰é’® -->
  <view class="map-actions">
    <button class="btn btn-outline" bindtap="onMapSelectorClose">å–æ¶ˆ</button>
    <button class="btn btn-primary" bindtap="onMapConfirm">ç¡®è®¤ä½ç½®</button>
  </view>
</view>