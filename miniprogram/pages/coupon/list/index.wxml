<!-- ä¼˜æƒ åˆ¸åˆ—è¡¨é¡µ -->
<view class="coupon-list-page">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="page-header">
    <text class="page-title">æˆ‘çš„ä¼˜æƒ åˆ¸</text>
    <view class="coupon-stats">
      <text class="stats-text">{{couponStats.available}}å¼ å¯ç”¨</text>
    </view>
  </view>

  <!-- ä¼˜æƒ åˆ¸ç±»å‹æ ‡ç­¾ -->
  <view class="coupon-tabs">
    <scroll-view class="tabs-scroll" scroll-x="true">
      <view class="tabs-list">
        <text
          class="tab-item {{currentTab === 'available' ? 'active' : ''}}"
          bindtap="onTabChange"
          data-tab="available"
        >
          å¯ä½¿ç”¨
          <view class="tab-badge" wx:if="{{couponStats.available > 0}}">
            <text class="badge-count">{{couponStats.available}}</text>
          </view>
        </text>
        <text
          class="tab-item {{currentTab === 'used' ? 'active' : ''}}"
          bindtap="onTabChange"
          data-tab="used"
        >
          å·²ä½¿ç”¨
          <view class="tab-badge" wx:if="{{couponStats.used > 0}}">
            <text class="badge-count">{{couponStats.used}}</text>
          </view>
        </text>
        <text
          class="tab-item {{currentTab === 'expired' ? 'active' : ''}}"
          bindtap="onTabChange"
          data-tab="expired"
        >
          å·²è¿‡æœŸ
          <view class="tab-badge" wx:if="{{couponStats.expired > 0}}">
            <text class="badge-count">{{couponStats.expired}}</text>
          </view>
        </text>
      </view>
    </scroll-view>
  </view>

  <!-- ä¼˜æƒ åˆ¸åˆ—è¡¨ -->
  <scroll-view class="coupon-scroll" scroll-y="true" style="height: {{scrollHeight}}" bindscrolltolower="onLoadMore">
    <view class="coupon-list">
      <!-- å¯ç”¨ä¼˜æƒ åˆ¸ -->
      <view class="available-coupons" wx:if="{{currentTab === 'available'}}">
        <!-- VIPä¸“äº«ä¼˜æƒ åˆ¸ -->
        <view class="vip-section" wx:if="{{vipCoupons.length > 0}}">
          <view class="vip-header">
            <text class="vip-title">VIPä¸“äº«</text>
            <text class="vip-badge">ä»…é™ä¼šå‘˜</text>
          </view>
          <view class="coupon-grid">
            <view
              class="coupon-card vip"
              wx:for="{{vipCoupons}}"
              wx:key="id"
              bindtap="onCouponTap"
              data-coupon="{{item}}"
            >
              <!-- ä¼˜æƒ åˆ¸è®¾è®¡ -->
              <view class="coupon-design">
                <view class="coupon-left">
                  <view class="coupon-amount">
                    <text class="amount-symbol">Â¥</text>
                    <text class="amount-value">{{item.discount}}</text>
                  </view>
                  <text class="coupon-condition">{{item.minAmount > 0 ? `æ»¡${item.minAmount}å…ƒå¯ç”¨` : 'æ— é—¨æ§›'}}</text>
                </view>
                <view class="coupon-divider">
                  <view class="divider-dots">
                    <text class="dot" wx:for="{{[1,2,3,4,5,6]}}" wx:key="*this">â€¢</text>
                  </view>
                </view>
                <view class="coupon-right">
                  <text class="coupon-title">{{item.name}}</text>
                  <text class="coupon-desc">{{item.description}}</text>
                  <view class="coupon-expire">
                    <text class="expire-text">æœ‰æ•ˆæœŸè‡³ {{item.expireDate}}</text>
                  </view>
                </view>
              </view>

              <!-- VIPæ ‡è¯† -->
              <view class="vip-overlay">
                <text class="vip-icon">ğŸ‘‘</text>
                <text class="vip-text">VIPä¸“äº«</text>
              </view>

              <!-- ä½¿ç”¨æŒ‰é’® -->
              <view class="coupon-action">
                <button class="use-btn" bindtap="onUseCoupon" data-coupon="{{item}}">
                  ç«‹å³ä½¿ç”¨
                </button>
              </view>
            </view>
          </view>

          <!-- æ™®é€šä¼˜æƒ åˆ¸ -->
          <view class="regular-coupons" wx:if="{{regularCoupons.length > 0}}">
            <view class="section-header" wx:if="{{vipCoupons.length > 0}}">
              <text class="section-title">é€šç”¨ä¼˜æƒ åˆ¸</text>
            </view>
            <view class="coupon-list-vertical">
              <view
                class="coupon-card regular {{item.isUrgent ? 'urgent' : ''}}"
                wx:for="{{regularCoupons}}"
                wx:key="id"
                bindtap="onCouponTap"
                data-coupon="{{item}}"
              >
                <view class="coupon-design">
                  <view class="coupon-left">
                    <view class="coupon-amount">
                      <text class="amount-symbol">Â¥</text>
                      <text class="amount-value">{{item.discount}}</text>
                    </view>
                    <text class="coupon-condition">{{item.minAmount > 0 ? `æ»¡${item.minAmount}å…ƒå¯ç”¨` : 'æ— é—¨æ§›'}}</text>
                  </view>
                  <view class="coupon-divider">
                    <view class="divider-dots">
                      <text class="dot" wx:for="{{[1,2,3,4,5,6]}}" wx:key="*this">â€¢</text>
                    </view>
                  </view>
                  <view class="coupon-right">
                    <text class="coupon-title">{{item.name}}</text>
                    <text class="coupon-desc">{{item.description}}</text>
                    <view class="coupon-meta">
                      <text class="expire-text">{{item.expireDate}}å‰æœ‰æ•ˆ</text>
                      <text class="usage-limit" wx:if="{{item.usageLimit}}">é™{{item.usageLimit}}æ¬¡</text>
                    </view>
                  </view>
                </view>

                <!-- ç´§æ€¥æ ‡è¯† -->
                <view class="urgent-badge" wx:if="{{item.isUrgent}}">
                  <text class="urgent-text">ç´§æ€¥</text>
                </view>

                <!-- ä½¿ç”¨æŒ‰é’® -->
                <view class="coupon-action">
                  <button class="use-btn" bindtap="onUseCoupon" data-coupon="{{item}}">
                    ç«‹å³ä½¿ç”¨
                  </button>
                </view>
              </view>
            </view>
          </view>

          <!-- ç©ºçŠ¶æ€ -->
          <view class="empty-coupons" wx:if="{{vipCoupons.length === 0 && regularCoupons.length === 0}}">
            <text class="empty-icon">ğŸ«</text>
            <text class="empty-title">æš‚æ— å¯ç”¨ä¼˜æƒ åˆ¸</text>
            <text class="empty-desc">å¿«å»çœ‹çœ‹æœ‰ä»€ä¹ˆä¼˜æƒ æ´»åŠ¨å§</text>
            <button class="btn btn-primary" bindtap="onGoToActivities">
              æŸ¥çœ‹æ´»åŠ¨
            </button>
          </view>
        </view>

        <!-- å·²ä½¿ç”¨ä¼˜æƒ åˆ¸ -->
        <view class="used-coupons" wx:if="{{currentTab === 'used'}}">
          <view class="coupon-list-vertical">
            <view
              class="coupon-card used"
              wx:for="{{usedCoupons}}"
              wx:key="id"
              bindtap="onUsedCouponTap"
              data-coupon="{{item}}"
            >
              <view class="coupon-design">
                <view class="coupon-left">
                  <view class="coupon-amount">
                    <text class="amount-symbol">Â¥</text>
                    <text class="amount-value">{{item.discount}}</text>
                  </view>
                  <text class="coupon-condition">{{item.minAmount > 0 ? `æ»¡${item.minAmount}å…ƒå¯ç”¨` : 'æ— é—¨æ§›'}}</text>
                </view>
                <view class="coupon-divider">
                  <view class="divider-dots">
                    <text class="dot" wx:for="{{[1,2,3,4,5,6]}}" wx:key="*this">â€¢</text>
                  </view>
                </view>
                <view class="coupon-right">
                  <text class="coupon-title">{{item.name}}</text>
                  <text class="coupon-desc">{{item.description}}</text>
                  <view class="coupon-meta">
                    <text class="used-text">å·²äº {{item.usedAt}} ä½¿ç”¨</text>
                    <text class="used-order">è®¢å•å·ï¼š{{item.orderNo}}</text>
                  </view>
                </view>
              </view>

              <!-- å·²ä½¿ç”¨æ ‡è¯† -->
              <view class="used-overlay">
                <text class="used-icon">âœ“</text>
                <text class="used-label">å·²ä½¿ç”¨</text>
              </view>
            </view>
          </view>

          <!-- ç©ºçŠ¶æ€ -->
          <view class="empty-coupons" wx:if="{{usedCoupons.length === 0}}">
            <text class="empty-icon">ğŸ“‹</text>
            <text class="empty-title">æš‚æ— å·²ä½¿ç”¨ä¼˜æƒ åˆ¸</text>
            <text class="empty-desc">ä½¿ç”¨ä¼˜æƒ åˆ¸å¯ä»¥äº«å—æ›´å¤šä¼˜æƒ </text>
          </view>
        </view>

        <!-- å·²è¿‡æœŸä¼˜æƒ åˆ¸ -->
        <view class="expired-coupons" wx:if="{{currentTab === 'expired'}}">
          <view class="coupon-list-vertical">
            <view
              class="coupon-card expired"
              wx:for="{{expiredCoupons}}"
              wx:key="id"
              bindtap="onExpiredCouponTap"
              data-coupon="{{item}}"
            >
              <view class="coupon-design">
                <view class="coupon-left">
                  <view class="coupon-amount">
                    <text class="amount-symbol">Â¥</text>
                    <text class="amount-value">{{item.discount}}</text>
                  </view>
                  <text class="coupon-condition">{{item.minAmount > 0 ? `æ»¡${item.minAmount}å…ƒå¯ç”¨` : 'æ— é—¨æ§›'}}</text>
                </view>
                <view class="coupon-divider">
                  <view class="divider-dots">
                    <text class="dot" wx:for="{{[1,2,3,4,5,6]}}" wx:key="*this">â€¢</text>
                  </view>
                </view>
                <view class="coupon-right">
                  <text class="coupon-title">{{item.name}}</text>
                  <text class="coupon-desc">{{item.description}}</text>
                  <view class="coupon-meta">
                    <text class="expired-text">å·²äº {{item.expireDate}} è¿‡æœŸ</text>
                  </view>
                </view>
              </view>

              <!-- å·²è¿‡æœŸæ ‡è¯† -->
              <view class="expired-overlay">
                <text class="expired-icon">âœ—</text>
                <text class="expired-label">å·²è¿‡æœŸ</text>
              </view>
            </view>
          </view>

          <!-- ç©ºçŠ¶æ€ -->
          <view class="empty-coupons" wx:if="{{expiredCoupons.length === 0}}">
            <text class="empty-icon">â°</text>
            <text class="empty-title">æš‚æ— å·²è¿‡æœŸä¼˜æƒ åˆ¸</text>
            <text class="empty-desc">è®°å¾—åŠæ—¶ä½¿ç”¨ä¼˜æƒ åˆ¸å“¦</text>
          </view>
        </view>
      </view>

      <!-- åŠ è½½çŠ¶æ€ -->
      <view class="load-more" wx:if="{{hasMore}}">
        <text class="load-text">{{loading ? 'åŠ è½½ä¸­...' : 'ä¸Šæ‹‰åŠ è½½æ›´å¤š'}}</text>
      </view>

      <!-- æ²¡æœ‰æ›´å¤šæ•°æ® -->
      <view class="no-more" wx:if="{{!hasMore && getCurrentCoupons().length > 0}}">
        <text class="no-more-text">æ²¡æœ‰æ›´å¤šä¼˜æƒ åˆ¸äº†</text>
      </view>
    </view>
  </scroll-view>

  <!-- é¢†åˆ¸ä¸­å¿ƒå…¥å£ -->
  <view class="coupon-center-entry" wx:if="{{currentTab === 'available'}}">
    <view class="entry-content" bindtap="onGoToCouponCenter">
      <text class="entry-title">é¢†åˆ¸ä¸­å¿ƒ</text>
      <text class="entry-desc">æ›´å¤šä¼˜æƒ ç­‰ä½ æ¥æ‹¿</text>
      <text class="entry-arrow">></text>
    </view>
  </view>

  <!-- ä¼˜æƒ åˆ¸è¯¦æƒ…å¼¹çª— -->
  <view class="coupon-detail-modal {{showDetailModal ? 'show' : ''}}" bindtap="onDetailModalClose">
    <view class="detail-content" catchtap="onDetailModalContentTap">
      <view class="detail-header">
        <text class="detail-title">ä¼˜æƒ åˆ¸è¯¦æƒ…</text>
        <text class="detail-close" bindtap="onDetailModalClose">Ã—</text>
      </view>

      <scroll-view class="detail-body" scroll-y="true" wx:if="{{selectedCoupon}}">
        <!-- ä¼˜æƒ åˆ¸é¢„è§ˆ -->
        <view class="coupon-preview">
          <view class="coupon-card {{selectedCoupon.type || 'regular'}}">
            <view class="coupon-design">
              <view class="coupon-left">
                <view class="coupon-amount">
                  <text class="amount-symbol">Â¥</text>
                  <text class="amount-value">{{selectedCoupon.discount}}</text>
                </view>
                <text class="coupon-condition">{{selectedCoupon.minAmount > 0 ? `æ»¡${selectedCoupon.minAmount}å…ƒå¯ç”¨` : 'æ— é—¨æ§›'}}</text>
              </view>
              <view class="coupon-divider">
                <view class="divider-dots">
                  <text class="dot" wx:for="{{[1,2,3,4,5,6]}}" wx:key="*this">â€¢</text>
                </view>
              </view>
              <view class="coupon-right">
                <text class="coupon-title">{{selectedCoupon.name}}</text>
                <text class="coupon-desc">{{selectedCoupon.description}}</text>
              </view>
            </view>
          </view>
        </view>

        <!-- ä½¿ç”¨è¯´æ˜ -->
        <view class="usage-section">
          <text class="section-title">ä½¿ç”¨è¯´æ˜</text>
          <view class="usage-list">
            <text class="usage-item">â€¢ æœ‰æ•ˆæœŸï¼š{{selectedCoupon.expireDate}}</text>
            <text class="usage-item" wx:if="{{selectedCoupon.minAmount > 0}}">â€¢ ä½¿ç”¨é—¨æ§›ï¼šæ»¡{{selectedCoupon.minAmount}}å…ƒå¯ç”¨</text>
            <text class="usage-item" wx:if="{{selectedCoupon.usageLimit}}">â€¢ ä½¿ç”¨æ¬¡æ•°ï¼šé™{{selectedCoupon.usageLimit}}æ¬¡</text>
            <text class="usage-item" wx:if="{{selectedCoupon.applicableServices}}">â€¢ é€‚ç”¨æœåŠ¡ï¼š{{selectedCoupon.applicableServices}}</text>
            <text class="usage-item" wx:if="{{selectedCoupon.applicableTechnicians}}">â€¢ é€‚ç”¨æŠ€å¸ˆï¼š{{selectedCoupon.applicableTechnicians}}</text>
            <text class="usage-item">â€¢ æ¯ä¸ªè®¢å•é™ç”¨ä¸€å¼ ä¼˜æƒ åˆ¸</text>
            <text class="usage-item">â€¢ ä¼˜æƒ åˆ¸ä¸å¯å…‘æ¢ç°é‡‘</text>
            <text class="usage-item">â€¢ æœ€ç»ˆè§£é‡Šæƒå½’å¹³å°æ‰€æœ‰</text>
          </view>
        </view>

        <!-- ä½¿ç”¨è®°å½• -->
        <view class="history-section" wx:if="{{selectedCoupon.usageHistory}}">
          <text class="section-title">ä½¿ç”¨è®°å½•</text>
          <view class="history-list">
            <view
              class="history-item"
              wx:for="{{selectedCoupon.usageHistory}}"
              wx:key="id"
            >
              <text class="history-date">{{item.date}}</text>
              <text class="history-order">è®¢å•å·ï¼š{{item.orderNo}}</text>
              <text class="history-amount">æŠµæ‰£ï¼šÂ¥{{item.discountAmount}}</text>
            </view>
          </view>
        </view>
      </scroll-view>

      <view class="detail-footer">
        <button class="btn btn-primary" bindtap="onUseCouponFromDetail" data-coupon="{{selectedCoupon}}">
          ç«‹å³ä½¿ç”¨
        </button>
      </view>
    </view>
  </view>

  <!-- ä½¿ç”¨ä¼˜æƒ åˆ¸å¼¹çª— -->
  <view class="use-coupon-modal {{showUseModal ? 'show' : ''}}" bindtap="onUseModalClose">
    <view class="use-content" catchtap="onUseModalContentTap">
      <view class="use-header">
        <text class="use-title">é€‰æ‹©æœåŠ¡</text>
        <text class="use-close" bindtap="onUseModalClose">Ã—</text>
      </view>

      <scroll-view class="use-body" scroll-y="true">
        <!-- å½“å‰è®¢å•ä½¿ç”¨ -->
        <view class="current-order-section" wx:if="{{currentOrder}}">
          <text class="section-title">å½“å‰è®¢å•</text>
          <view class="order-preview">
            <text class="order-service">{{currentOrder.serviceName}}</text>
            <text class="order-technician">æŠ€å¸ˆï¼š{{currentOrder.technicianName}}</text>
            <text class="order-price">åŸä»·ï¼šÂ¥{{currentOrder.originalPrice}}</text>
            <text class="order-discount" wx:if="{{currentOrder.discount > 0}}">ä¼˜æƒ ï¼š-Â¥{{currentOrder.discount}}</text>
            <text class="order-final">å®ä»˜ï¼šÂ¥{{currentOrder.finalPrice}}</text>
          </view>
        </view>

        <!-- å¯ç”¨æœåŠ¡åˆ—è¡¨ -->
        <view class="services-section">
          <text class="section-title">å¯ç”¨æœåŠ¡</text>
          <view class="services-list">
            <view
              class="service-item {{currentServiceId === item.id ? 'selected' : ''}}"
              wx:for="{{availableServices}}"
              wx:key="id"
              bindtap="onServiceSelect"
              data-service="{{item}}"
            >
              <image class="service-icon" src="{{item.icon}}" mode="aspectFit" />
              <view class="service-info">
                <text class="service-name">{{item.name}}</text>
                <text class="service-price">Â¥{{item.price}}</text>
                <text class="service-desc">{{item.description}}</text>
              </view>
              <view class="service-select">
                <text class="select-icon">{{currentServiceId === item.id ? 'âœ“' : ''}}</text>
              </view>
            </view>
          </view>
        </view>
      </scroll-view>

      <view class="use-footer">
        <button class="btn btn-outline" bindtap="onUseModalClose">å–æ¶ˆ</button>
        <button
          class="btn btn-primary"
          bindtap="onConfirmUse"
          disabled="{{!currentServiceId && !currentOrder}}"
        >
          ç¡®è®¤ä½¿ç”¨
        </button>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨å®‰å…¨åŒºåŸŸ -->
  <view class="safe-area-bottom"></view>
</view>