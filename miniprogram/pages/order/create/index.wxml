<!-- 订单创建页 -->
<view class="order-create-page">
  <!-- 技师信息 -->
  <view class="technician-section card" wx:if="{{technicianInfo}}">
    <view class="section-title">技师信息</view>
    <view class="technician-info">
      <image class="technician-avatar" src="{{technicianInfo.avatar}}" mode="aspectFill" />
      <view class="technician-details">
        <text class="technician-name">{{technicianInfo.name}}</text>
        <view class="technician-meta">
          <text class="rating">{{technicianInfo.rating}} ⭐</text>
          <text class="order-count">{{technicianInfo.orderCount}}单</text>
          <text class="response-time">{{technicianInfo.responseTime}}分钟响应</text>
        </view>
        <view class="technician-tags">
          <text
            class="tag"
            wx:for="{{technicianInfo.tags}}"
            wx:for-item="tag"
            wx:key="*this"
          >{{tag}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 服务项目选择 -->
  <view class="service-section card">
    <view class="section-title">
      <text class="required">*</text>
      服务项目
    </view>
    <view class="service-options">
      <view
        class="service-option {{selectedService.id === item.id ? 'selected' : ''}}"
        wx:for="{{technicianInfo.services}}"
        wx:key="id"
        bindtap="onServiceSelect"
        data-service="{{item}}"
      >
        <view class="service-header">
          <text class="service-name">{{item.name}}</text>
          <view class="service-price">
            <text class="price-current">¥{{item.price}}</text>
            <text class="price-unit">/{{item.duration}}分钟</text>
          </view>
        </view>
        <text class="service-desc">{{item.description}}</text>
      </view>
    </view>
  </view>

  <!-- 预约时间 -->
  <view class="time-section card">
    <view class="section-title">
      <text class="required">*</text>
      预约时间
    </view>

    <!-- 日期选择 -->
    <view class="date-selector">
      <text class="selector-label">选择日期：</text>
      <picker
        mode="date"
        value="{{orderForm.date}}"
        start="{{minDate}}"
        bindchange="onDateChange"
      >
        <view class="picker-view">
          <text class="picker-text">{{orderForm.date || '请选择日期'}}</text>
          <text class="picker-arrow">▼</text>
        </view>
      </picker>
    </view>

    <!-- 时间段选择 -->
    <view class="time-selector">
      <text class="selector-label">选择时间：</text>
      <view class="time-slots">
        <view
          class="time-slot {{orderForm.timeSlot === item.time ? 'selected' : ''}} {{item.disabled ? 'disabled' : ''}}"
          wx:for="{{timeSlots}}"
          wx:key="time"
          bindtap="onTimeSlotSelect"
          data-timeslot="{{item}}"
        >
          <text class="slot-time">{{item.time}}</text>
          <text class="slot-status" wx:if="{{item.status}}">{{item.status}}</text>
        </view>
      </view>
    </view>

    <!-- 紧急预约 -->
    <view class="urgent-option">
      <checkbox-group bindchange="onUrgentChange">
        <label class="urgent-label">
          <checkbox value="urgent" checked="{{orderForm.isUrgent}}" />
          <text class="urgent-text">紧急预约（尽快安排，可能产生额外费用）</text>
        </label>
      </checkbox-group>
    </view>
  </view>

  <!-- 服务地址 -->
  <view class="address-section card">
    <view class="section-title">
      <text class="required">*</text>
      服务地址
    </view>

    <!-- 地址选择 -->
    <view class="address-selector" bindtap="onAddressSelect">
      <view class="address-content" wx:if="{{selectedAddress}}">
        <view class="address-main">
          <text class="address-name">{{selectedAddress.name}}</text>
          <text class="address-phone">{{selectedAddress.phone}}</text>
        </view>
        <text class="address-detail">{{selectedAddress.fullAddress}}</text>
      </view>
      <view class="address-placeholder" wx:else>
        <text class="placeholder-text">请选择服务地址</text>
      </view>
      <text class="address-arrow">></text>
    </view>

    <!-- 地址列表快捷选择 -->
    <view class="address-shortcuts" wx:if="{{addressList.length > 0}}">
      <text
        class="address-shortcut"
        wx:for="{{addressList}}"
        wx:key="id"
        bindtap="onAddressShortcutSelect"
        data-address="{{item}}"
      >{{item.name}}</text>
    </view>
  </view>

  <!-- 联系电话 -->
  <view class="phone-section card">
    <view class="section-title">
      <text class="required">*</text>
      联系电话
    </view>
    <input
      class="phone-input"
      type="number"
      placeholder="请输入联系电话"
      value="{{orderForm.phone}}"
      bindinput="onPhoneInput"
      maxlength="11"
    />
    <text class="phone-hint">技师将在服务前联系您确认详情</text>
  </view>

  <!-- 备注 -->
  <view class="note-section card">
    <view class="section-title">备注信息</view>
    <textarea
      class="note-textarea"
      placeholder="请输入特殊要求或注意事项（选填）"
      value="{{orderForm.note}}"
      bindinput="onNoteInput"
      maxlength="200"
    />
    <view class="note-count">{{orderForm.note.length}}/200</view>
  </view>

  <!-- 优惠信息 -->
  <view class="coupon-section card" wx:if="{{coupons.length > 0}}">
    <view class="section-title">优惠券</view>
    <view class="coupon-selector" bindtap="onCouponSelect">
      <view class="coupon-content" wx:if="{{selectedCoupon}}">
        <text class="coupon-name">{{selectedCoupon.name}}</text>
        <text class="coupon-desc">-¥{{selectedCoupon.discount}}</text>
      </view>
      <view class="coupon-placeholder" wx:else>
        <text class="placeholder-text">选择优惠券</text>
      </view>
      <text class="coupon-arrow">></text>
    </view>
  </view>

  <!-- 价格明细 -->
  <view class="price-section card">
    <view class="section-title">费用明细</view>
    <view class="price-details">
      <view class="price-item">
        <text class="price-label">服务费用</text>
        <text class="price-value">¥{{calculateServicePrice()}}</text>
      </view>
      <view class="price-item" wx:if="{{orderForm.isUrgent}}">
        <text class="price-label">紧急服务费</text>
        <text class="price-value">¥{{urgentFee}}</text>
      </view>
      <view class="price-item" wx:if="{{calculateDistanceFee() > 0}}">
        <text class="price-label">远程服务费</text>
        <text class="price-value">¥{{calculateDistanceFee()}}</text>
      </view>
      <view class="price-item discount" wx:if="{{selectedCoupon}}">
        <text class="price-label">优惠券</text>
        <text class="price-value">-¥{{selectedCoupon.discount}}</text>
      </view>
      <view class="price-divider"></view>
      <view class="price-item total">
        <text class="price-label">合计</text>
        <text class="price-value">¥{{calculateTotalPrice()}}</text>
      </view>
    </view>
  </view>

  <!-- 服务协议 -->
  <view class="agreement-section">
    <checkbox-group bindchange="onAgreementChange">
      <label class="agreement-label">
        <checkbox value="agree" checked="{{orderForm.agreed}}" />
        <text class="agreement-text">
          我已阅读并同意
          <text class="agreement-link" bindtap="onAgreementTap">《服务协议》</text>
          和
          <text class="agreement-link" bindtap="onPrivacyTap">《隐私政策》</text>
        </text>
      </label>
    </checkbox-group>
  </view>

  <!-- 底部操作栏 -->
  <view class="bottom-bar">
    <view class="price-info">
      <text class="price-label">预计费用</text>
      <text class="price-amount">¥{{calculateTotalPrice()}}</text>
    </view>
    <button
      class="btn-submit"
      bindtap="onSubmit"
      disabled="{{!canSubmit() || submitting}}"
    >
      {{submitting ? '提交中...' : '确认预约'}}
    </button>
  </view>
</view>

<!-- 底部安全区域适配 -->
<view class="safe-area-bottom"></view>

<!-- 优惠券选择弹窗 -->
<view class="coupon-modal {{showCouponModal ? 'show' : ''}}" bindtap="onCouponModalClose">
  <view class="coupon-content" catchtap="onCouponModalContentTap">
    <view class="modal-header">
      <text class="modal-title">选择优惠券</text>
      <text class="modal-close" bindtap="onCouponModalClose">×</text>
    </view>
    <scroll-view class="coupon-list" scroll-y="true">
      <view
        class="coupon-item {{selectedCoupon.id === item.id ? 'selected' : ''}}"
        wx:for="{{coupons}}"
        wx:key="id"
        bindtap="onCouponItemClick"
        data-coupon="{{item}}"
      >
        <view class="coupon-info">
          <text class="coupon-name">{{item.name}}</text>
          <text class="coupon-desc">{{item.description}}</text>
          <text class="coupon-expire">有效期至：{{item.expireDate}}</text>
        </view>
        <view class="coupon-amount">-¥{{item.discount}}</view>
      </view>
    </scroll-view>
    <view class="modal-footer">
      <button class="btn btn-outline" bindtap="onCouponModalClose">不使用优惠券</button>
    </view>
  </view>
</view>