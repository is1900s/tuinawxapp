<!-- è®¢å•è¯¦æƒ…é¡µ -->
<scroll-view class="order-detail-page" scroll-y="true">
  <!-- è®¢å•çŠ¶æ€å¡ç‰‡ -->
  <view class="status-card">
    <!-- çŠ¶æ€å›¾æ ‡å’Œæ–‡æœ¬ -->
    <view class="status-header">
      <view class="status-icon-wrapper status-{{orderInfo.status}}">
        <text class="status-icon">{{getStatusIcon(orderInfo.status)}}</text>
      </view>
      <view class="status-info">
        <text class="status-title">{{getStatusTitle(orderInfo.status)}}</text>
        <text class="status-desc">{{getStatusDesc(orderInfo.status)}}</text>
      </view>
    </view>

    <!-- è®¢å•è¿›åº¦ -->
    <view class="order-timeline" wx:if="{{orderInfo.timeline}}">
      <view
        class="timeline-item {{item.completed ? 'completed' : ''}} {{item.current ? 'current' : ''}}"
        wx:for="{{orderInfo.timeline}}"
        wx:key="time"
      >
        <view class="timeline-dot">
          <text class="dot-icon">{{item.completed ? 'âœ“' : 'â—‹'}}</text>
        </view>
        <view class="timeline-content">
          <text class="timeline-title">{{item.title}}</text>
          <text class="timeline-time">{{item.time}}</text>
        </view>
        <view class="timeline-line" wx:if="{{!$last}}"></view>
      </view>
    </view>
  </view>

  <!-- æœåŠ¡ä¿¡æ¯ -->
  <view class="service-section card">
    <view class="section-header">
      <text class="section-title">æœåŠ¡ä¿¡æ¯</text>
    </view>

    <view class="service-content">
      <view class="service-header">
        <image class="service-image" src="{{orderInfo.service.icon}}" mode="aspectFill" />
        <view class="service-info">
          <text class="service-name">{{orderInfo.service.name}}</text>
          <text class="service-desc">{{orderInfo.service.description}}</text>
          <view class="service-meta">
            <text class="service-duration">{{orderInfo.service.duration}}åˆ†é’Ÿ</text>
            <text class="service-price">Â¥{{orderInfo.basePrice}}</text>
          </view>
        </view>
      </view>

      <!-- é¢„çº¦è¯¦æƒ… -->
      <view class="appointment-details">
        <view class="detail-item">
          <text class="detail-label">é¢„çº¦æ—¶é—´</text>
          <text class="detail-value">{{orderInfo.appointmentTime}}</text>
        </view>
        <view class="detail-item" wx:if="{{orderInfo.actualStartTime}}">
          <text class="detail-label">å¼€å§‹æ—¶é—´</text>
          <text class="detail-value">{{orderInfo.actualStartTime}}</text>
        </view>
        <view class="detail-item" wx:if="{{orderInfo.actualEndTime}}">
          <text class="detail-label">ç»“æŸæ—¶é—´</text>
          <text class="detail-value">{{orderInfo.actualEndTime}}</text>
        </view>
        <view class="detail-item" wx:if="{{orderInfo.actualDuration}}">
          <text class="detail-label">æœåŠ¡æ—¶é•¿</text>
          <text class="detail-value">{{orderInfo.actualDuration}}åˆ†é’Ÿ</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æŠ€å¸ˆä¿¡æ¯ -->
  <view class="technician-section card">
    <view class="section-header">
      <text class="section-title">æŠ€å¸ˆä¿¡æ¯</text>
      <text class="section-more" bindtap="onTechnicianTap" data-technician="{{orderInfo.technician}}">æŸ¥çœ‹è¯¦æƒ… ></text>
    </view>

    <view class="technician-content">
      <view class="technician-header">
        <image class="technician-avatar" src="{{orderInfo.technician.avatar}}" mode="aspectFill" />
        <view class="technician-info">
          <text class="technician-name">{{orderInfo.technician.name}}</text>
          <view class="technician-meta">
            <text class="technician-rating">{{orderInfo.technician.rating}} â­</text>
            <text class="technician-orders">{{orderInfo.technician.orderCount}}å•</text>
            <text class="technician-badge" wx:if="{{orderInfo.technician.verified}}">å·²è®¤è¯</text>
          </view>
        </view>
        <view class="technician-actions">
          <button class="action-btn" bindtap="onContactTechnician" data-technician="{{orderInfo.technician}}">
            è”ç³»æŠ€å¸ˆ
          </button>
        </view>
      </view>

      <!-- æŠ€å¸ˆæŠ€èƒ½ -->
      <view class="technician-skills" wx:if="{{orderInfo.technician.skills}}">
        <text
          class="skill-tag"
          wx:for="{{orderInfo.technician.skills}}"
          wx:key="name"
        >{{item.name}}</text>
      </view>
    </view>
  </view>

  <!-- æœåŠ¡åœ°å€ -->
  <view class="address-section card">
    <view class="section-header">
      <text class="section-title">æœåŠ¡åœ°å€</text>
      <text class="section-more" bindtap="onAddressTap" data-address="{{orderInfo.address}}">æŸ¥çœ‹åœ°å›¾ ></text>
    </view>

    <view class="address-content">
      <view class="address-header">
        <text class="address-icon">ğŸ“</text>
        <view class="address-info">
          <text class="address-name">{{orderInfo.address.name}}</text>
          <text class="address-phone">{{orderInfo.address.phone}}</text>
        </view>
      </view>
      <text class="address-detail">{{orderInfo.address.fullAddress}}</text>
      <text class="address-note" wx:if="{{orderInfo.address.note}}">
        å¤‡æ³¨ï¼š{{orderInfo.address.note}}
      </text>
    </view>
  </view>

  <!-- è´¹ç”¨æ˜ç»† -->
  <view class="price-section card">
    <view class="section-header">
      <text class="section-title">è´¹ç”¨æ˜ç»†</text>
    </view>

    <view class="price-details">
      <view class="price-item">
        <text class="price-label">æœåŠ¡è´¹ç”¨</text>
        <text class="price-value">Â¥{{orderInfo.basePrice}}</text>
      </view>
      <view class="price-item" wx:if="{{orderInfo.urgentFee > 0}}">
        <text class="price-label">ç´§æ€¥æœåŠ¡è´¹</text>
        <text class="price-value">Â¥{{orderInfo.urgentFee}}</text>
      </view>
      <view class="price-item" wx:if="{{orderInfo.distanceFee > 0}}">
        <text class="price-label">è¿œç¨‹æœåŠ¡è´¹</text>
        <text class="price-value">Â¥{{orderInfo.distanceFee}}</text>
      </view>
      <view class="price-item discount" wx:if="{{orderInfo.couponDiscount > 0}}">
        <text class="price-label">ä¼˜æƒ åˆ¸æŠµæ‰£</text>
        <text class="price-value">-Â¥{{orderInfo.couponDiscount}}</text>
      </view>
      <view class="price-divider"></view>
      <view class="price-item total">
        <text class="price-label">å®ä»˜é‡‘é¢</text>
        <text class="price-value">Â¥{{orderInfo.totalPrice}}</text>
      </view>
    </view>
  </view>

  <!-- è®¢å•ä¿¡æ¯ -->
  <view class="order-info-section card">
    <view class="section-header">
      <text class="section-title">è®¢å•ä¿¡æ¯</text>
    </view>

    <view class="order-info-details">
      <view class="info-item">
        <text class="info-label">è®¢å•ç¼–å·</text>
        <view class="info-value">
          <text class="order-no">{{orderInfo.orderNo}}</text>
          <text class="copy-btn" bindtap="onCopyOrderNo">å¤åˆ¶</text>
        </view>
      </view>
      <view class="info-item">
        <text class="info-label">ä¸‹å•æ—¶é—´</text>
        <text class="info-value">{{orderInfo.createdAt}}</text>
      </view>
      <view class="info-item">
        <text class="info-label">æ”¯ä»˜æ–¹å¼</text>
        <text class="info-value">{{getPaymentMethod(orderInfo.paymentMethod)}}</text>
      </view>
      <view class="info-item" wx:if="{{orderInfo.paidAt}}">
        <text class="info-label">æ”¯ä»˜æ—¶é—´</text>
        <text class="info-value">{{orderInfo.paidAt}}</text>
      </view>
      <view class="info-item" wx:if="{{orderInfo.note}}">
        <text class="info-label">è®¢å•å¤‡æ³¨</text>
        <text class="info-value">{{orderInfo.note}}</text>
      </view>
    </view>
  </view>

  <!-- æœåŠ¡ç…§ç‰‡ -->
  <view class="photos-section card" wx:if="{{orderInfo.servicePhotos && orderInfo.servicePhotos.length > 0}}">
    <view class="section-header">
      <text class="section-title">æœåŠ¡ç…§ç‰‡</text>
    </view>

    <view class="photos-grid">
      <image
        class="photo-item"
        wx:for="{{orderInfo.servicePhotos}}"
        wx:key="*this"
        src="{{item}}"
        mode="aspectFill"
        bindtap="onPhotoPreview"
        data-urls="{{orderInfo.servicePhotos}}"
        data-current="{{item}}"
      />
    </view>
  </view>

  <!-- æŠ€å¸ˆå¤‡æ³¨ -->
  <view class="technician-note-section card" wx:if="{{orderInfo.technicianNote}}">
    <view class="section-header">
      <text class="section-title">æŠ€å¸ˆå¤‡æ³¨</text>
    </view>
    <text class="technician-note-text">{{orderInfo.technicianNote}}</text>
  </view>

  <!-- ç”¨æˆ·è¯„ä»· -->
  <view class="review-section card" wx:if="{{orderInfo.review}}">
    <view class="section-header">
      <text class="section-title">æˆ‘çš„è¯„ä»·</text>
      <text class="section-more" bindtap="onEditReview" wx:if="{{canEditReview}}">ä¿®æ”¹ ></text>
    </view>

    <view class="review-content">
      <view class="review-header">
        <view class="review-rating">
          <text class="rating-stars">{{orderInfo.review.rating}} â­</text>
          <text class="review-date">{{orderInfo.review.createdAt}}</text>
        </view>
      </view>

      <text class="review-content-text">{{orderInfo.review.content}}</text>

      <view class="review-tags" wx:if="{{orderInfo.review.tags}}">
        <text
          class="review-tag"
          wx:for="{{orderInfo.review.tags}}"
          wx:key="*this"
        >{{item}}</text>
      </view>

      <view class="review-images" wx:if="{{orderInfo.review.images}}">
        <image
          class="review-image"
          wx:for="{{orderInfo.review.images}}"
          wx:for-item="image"
          wx:key="*this"
          src="{{image}}"
          mode="aspectFill"
          bindtap="onReviewImagePreview"
          data-urls="{{orderInfo.review.images}}"
          data-current="{{image}}"
        />
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="bottom-actions" wx:if="{{bottomActions.length > 0}}">
    <button
      class="action-btn {{item.style}}"
      wx:for="{{bottomActions}}"
      wx:key="text"
      bindtap="onBottomActionTap"
      data-action="{{item}}"
    >
      {{item.text}}
    </button>
  </view>

  <!-- åº•éƒ¨é—´è· -->
  <view class="bottom-spacer"></view>
</scroll-view>

<!-- å›¾ç‰‡é¢„è§ˆ -->
<view class="image-preview-modal {{showImagePreview ? 'show' : ''}}" bindtap="onImagePreviewClose">
  <view class="preview-content" catchtap="onImagePreviewContentTap">
    <swiper
      class="preview-swiper"
      indicator-dots="{{previewImages.length > 1}}"
      current="{{previewIndex}}"
      bindchange="onPreviewChange"
    >
      <swiper-item wx:for="{{previewImages}}" wx:key="*this">
        <image class="preview-image" src="{{item}}" mode="aspectFit" />
      </swiper-item>
    </swiper>
    <text class="preview-close" bindtap="onImagePreviewClose">Ã—</text>
  </view>
</view>

<!-- è”ç³»æŠ€å¸ˆå¼¹çª— -->
<view class="contact-modal {{showContactModal ? 'show' : ''}}" bindtap="onContactModalClose">
  <view class="contact-content" catchtap="onContactModalContentTap">
    <view class="contact-header">
      <text class="contact-title">è”ç³»æŠ€å¸ˆ</text>
      <text class="contact-close" bindtap="onContactModalClose">Ã—</text>
    </view>

    <view class="contact-options">
      <view class="contact-option" bindtap="onPhoneCall">
        <text class="contact-icon">ğŸ“</text>
        <text class="contact-text">ç”µè¯è”ç³»</text>
      </view>
      <view class="contact-option" bindtap="onSendMessage">
        <text class="contact-icon">ğŸ’¬</text>
        <text class="contact-text">å‘é€æ¶ˆæ¯</text>
      </view>
      <view class="contact-option" bindtap="onWechatContact">
        <text class="contact-icon">ğŸ“±</text>
        <text class="contact-text">å¾®ä¿¡è”ç³»</text>
      </view>
    </view>
  </view>
</view>

<!-- ä¿®æ”¹è¯„ä»·å¼¹çª— -->
<view class="edit-review-modal {{showEditReviewModal ? 'show' : ''}}" bindtap="onEditReviewModalClose">
  <view class="edit-review-content" catchtap="onEditReviewModalContentTap">
    <view class="edit-review-header">
      <text class="edit-review-title">ä¿®æ”¹è¯„ä»·</text>
      <text class="edit-review-close" bindtap="onEditReviewModalClose">Ã—</text>
    </view>

    <view class="edit-review-body">
      <!-- è¯„åˆ† -->
      <view class="rating-section">
        <text class="rating-label">æœåŠ¡è¯„åˆ†</text>
        <view class="rating-stars">
          <text
            class="star {{index < editReviewForm.rating ? 'filled' : ''}}"
            wx:for="{{[1,2,3,4,5]}}"
            wx:key="*this"
            bindtap="onRatingTap"
            data-rating="{{index + 1}}"
          >â˜…</text>
        </view>
      </view>

      <!-- è¯„ä»·å†…å®¹ -->
      <view class="content-section">
        <text class="content-label">è¯„ä»·å†…å®¹</text>
        <textarea
          class="content-textarea"
          placeholder="è¯·è¾“å…¥æ‚¨çš„è¯„ä»·..."
          value="{{editReviewForm.content}}"
          bindinput="onContentInput"
          maxlength="500"
        />
        <text class="content-count">{{editReviewForm.content.length}}/500</text>
      </view>

      <!-- æ ‡ç­¾ -->
      <view class="tags-section">
        <text class="tags-label">å¿«é€Ÿæ ‡ç­¾</text>
        <view class="tags-list">
          <text
            class="tag-item {{editReviewForm.tags.includes(item) ? 'selected' : ''}}"
            wx:for="{{reviewTags}}"
            wx:key="*this"
            bindtap="onTagTap"
            data-tag="{{item}}"
          >{{item}}</text>
        </view>
      </view>
    </view>

    <view class="edit-review-footer">
      <button class="btn btn-outline" bindtap="onEditReviewModalClose">å–æ¶ˆ</button>
      <button class="btn btn-primary" bindtap="onSubmitEditReview">ä¿å­˜ä¿®æ”¹</button>
    </view>
  </view>
</view>

<!-- å®‰å…¨åŒºåŸŸé€‚é… -->
<view class="safe-area-bottom"></view>