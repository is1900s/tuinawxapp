<!-- è®¢å•åˆ—è¡¨é¡µ -->
<view class="order-list-page">
  <!-- çŠ¶æ€æ ‡ç­¾æ  -->
  <view class="status-tabs">
    <scroll-view class="tabs-scroll" scroll-x="true">
      <view class="tabs-list">
        <text
          class="tab-item {{currentStatus === item.status ? 'active' : ''}}"
          wx:for="{{statusTabs}}"
          wx:key="status"
          bindtap="onStatusChange"
          data-status="{{item.status}}"
        >
          {{item.name}}
          <view class="tab-badge" wx:if="{{item.count > 0}}">
            <text class="badge-count">{{item.count > 99 ? '99+' : item.count}}</text>
          </view>
        </text>
      </view>
    </scroll-view>
  </view>

  <!-- æœç´¢å’Œç­›é€‰ -->
  <view class="search-filter-bar">
    <view class="search-section">
      <view class="search-input" bindtap="onSearchTap">
        <text class="search-icon">ğŸ”</text>
        <text class="search-placeholder">æœç´¢è®¢å•</text>
      </view>
    </view>

    <!-- ç­›é€‰æŒ‰é’® -->
    <view class="filter-btn" bindtap="onFilterTap">
      <text class="filter-icon">ğŸ”½</text>
      <text class="filter-text">ç­›é€‰</text>
    </view>
  </view>

  <!-- è®¢å•åˆ—è¡¨ -->
  <scroll-view class="order-scroll" scroll-y="true" bindscrolltolower="onLoadMore" style="height: {{scrollHeight}}">
    <view class="order-list">
      <!-- è®¢å•é¡¹ -->
      <view
        class="order-item"
        wx:for="{{orders}}"
        wx:key="id"
        bindtap="onOrderTap"
        data-order="{{item}}"
      >
        <!-- è®¢å•å¤´éƒ¨ -->
        <view class="order-header">
          <view class="order-info">
            <text class="order-no">è®¢å•å·ï¼š{{item.orderNo}}</text>
            <text class="order-date">{{item.createdAt}}</text>
          </view>
          <view class="order-status status-{{item.status}}">
            <text class="status-text">{{getStatusText(item.status)}}</text>
          </view>
        </view>

        <!-- æœåŠ¡ä¿¡æ¯ -->
        <view class="service-section">
          <view class="service-info">
            <image class="technician-avatar" src="{{item.technician.avatar}}" mode="aspectFill" />
            <view class="service-details">
              <text class="service-name">{{item.service.name}}</text>
              <text class="technician-name">æŠ€å¸ˆï¼š{{item.technician.name}}</text>
              <view class="service-meta">
                <text class="service-duration">{{item.service.duration}}åˆ†é’Ÿ</text>
                <text class="service-price">Â¥{{item.totalPrice}}</text>
              </view>
            </view>
          </view>

          <!-- æœåŠ¡åœ°å€ -->
          <view class="service-address" wx:if="{{item.address}}">
            <text class="address-icon">ğŸ“</text>
            <text class="address-text">{{item.address.name}} - {{item.address.fullAddress}}</text>
          </view>

          <!-- é¢„çº¦æ—¶é—´ -->
          <view class="appointment-time">
            <text class="time-icon">â°</text>
            <text class="time-text">é¢„çº¦æ—¶é—´ï¼š{{item.appointmentTime}}</text>
          </view>
        </view>

        <!-- æ“ä½œæŒ‰é’® -->
        <view class="order-actions" wx:if="{{item.actions && item.actions.length > 0}}">
          <button
            class="action-btn {{item.style}}"
            wx:for="{{item.actions}}"
            wx:for-item="action"
            wx:key="text"
            bindtap="onActionTap"
            data-action="{{action}}"
            data-order="{{item}}"
          >
            {{action.text}}
          </button>
        </view>

        <!-- è®¢å•è¿›åº¦ -->
        <view class="order-progress" wx:if="{{showProgress && item.progress}}">
          <view class="progress-steps">
            <view
              class="progress-step {{step.completed ? 'completed' : ''}} {{step.current ? 'current' : ''}}"
              wx:for="{{item.progress}}"
              wx:key="step"
            >
              <view class="step-icon">{{step.completed ? 'âœ“' : step.index}}</view>
              <text class="step-text">{{step.text}}</text>
              <view class="step-line" wx:if="{{!$last}}"></view>
            </view>
          </view>
        </view>
      </view>

      <!-- åŠ è½½çŠ¶æ€ -->
      <view class="load-more" wx:if="{{hasMore}}">
        <text class="load-text">{{loading ? 'åŠ è½½ä¸­...' : 'ä¸Šæ‹‰åŠ è½½æ›´å¤š'}}</text>
      </view>

      <!-- æ²¡æœ‰æ›´å¤šæ•°æ® -->
      <view class="no-more" wx:if="{{!hasMore && orders.length > 0}}">
        <text class="no-more-text">æ²¡æœ‰æ›´å¤šè®¢å•äº†</text>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:if="{{orders.length === 0 && !loading}}">
        <text class="empty-icon">ğŸ“‹</text>
        <text class="empty-title">æš‚æ— è®¢å•</text>
        <text class="empty-desc">{{getEmptyDesc()}}</text>
        <button class="btn btn-primary" bindtap="onBookNow" wx:if="{{currentStatus === 'all'}}">
          ç«‹å³é¢„çº¦
        </button>
      </view>
    </view>
  </scroll-view>
</view>

<!-- ç­›é€‰å¼¹çª— -->
<view class="filter-modal {{showFilterModal ? 'show' : ''}}" bindtap="onFilterModalClose">
  <view class="filter-content" catchtap="onFilterModalContentTap">
    <view class="filter-header">
      <text class="filter-title">ç­›é€‰è®¢å•</text>
      <text class="filter-close" bindtap="onFilterModalClose">Ã—</text>
    </view>

    <view class="filter-body">
      <!-- æ—¶é—´ç­›é€‰ -->
      <view class="filter-group">
        <text class="group-title">æ—¶é—´èŒƒå›´</text>
        <view class="filter-options">
          <label class="option-item" wx:for="{{timeOptions}}" wx:key="value">
            <radio
              value="{{item.value}}"
              checked="{{filters.timeRange === item.value}}"
              bindchange="onTimeRangeChange"
            />
            <text class="option-text">{{item.label}}</text>
          </label>
        </view>
      </view>

      <!-- æœåŠ¡ç±»å‹ç­›é€‰ -->
      <view class="filter-group">
        <text class="group-title">æœåŠ¡ç±»å‹</text>
        <view class="filter-options">
          <label class="option-item" wx:for="{{serviceTypes}}" wx:key="id">
            <checkbox
              value="{{item.id}}"
              checked="{{filters.serviceTypes.includes(item.id)}}"
              bindchange="onServiceTypeChange"
              data-service="{{item.id}}"
            />
            <text class="option-text">{{item.name}}</text>
          </label>
        </view>
      </view>

      <!-- ä»·æ ¼åŒºé—´ç­›é€‰ -->
      <view class="filter-group">
        <text class="group-title">ä»·æ ¼åŒºé—´</text>
        <view class="price-range">
          <input
            class="price-input"
            type="digit"
            placeholder="æœ€ä½ä»·"
            value="{{filters.minPrice}}"
            bindinput="onMinPriceInput"
          />
          <text class="price-separator">-</text>
          <input
            class="price-input"
            type="digit"
            placeholder="æœ€é«˜ä»·"
            value="{{filters.maxPrice}}"
            bindinput="onMaxPriceInput"
          />
        </view>
      </view>

      <!-- æŠ€å¸ˆç­›é€‰ -->
      <view class="filter-group">
        <text class="group-title">æŠ€å¸ˆæ€§åˆ«</text>
        <view class="filter-options">
          <label class="option-item">
            <radio
              value="all"
              checked="{{filters.technicianGender === 'all'}}"
              bindchange="onTechnicianGenderChange"
            />
            <text class="option-text">ä¸é™</text>
          </label>
          <label class="option-item">
            <radio
              value="male"
              checked="{{filters.technicianGender === 'male'}}"
              bindchange="onTechnicianGenderChange"
            />
            <text class="option-text">ç”·æŠ€å¸ˆ</text>
          </label>
          <label class="option-item">
            <radio
              value="female"
              checked="{{filters.technicianGender === 'female'}}"
              bindchange="onTechnicianGenderChange"
            />
            <text class="option-text">å¥³æŠ€å¸ˆ</text>
          </label>
        </view>
      </view>
    </view>

    <view class="filter-footer">
      <button class="btn btn-outline" bindtap="onResetFilter">é‡ç½®</button>
      <button class="btn btn-primary" bindtap="onApplyFilter">ç¡®å®š</button>
    </view>
  </view>
</view>

<!-- å–æ¶ˆè®¢å•å¼¹çª— -->
<view class="cancel-modal {{showCancelModal ? 'show' : ''}}" bindtap="onCancelModalClose">
  <view class="cancel-content" catchtap="onCancelModalContentTap">
    <view class="cancel-header">
      <text class="cancel-title">å–æ¶ˆè®¢å•</text>
      <text class="cancel-close" bindtap="onCancelModalClose">Ã—</text>
    </view>

    <view class="cancel-body">
      <text class="cancel-desc">è¯·é€‰æ‹©å–æ¶ˆåŸå› </text>
      <radio-group class="reason-group" bindchange="onCancelReasonChange">
        <label class="reason-item" wx:for="{{cancelReasons}}" wx:key="id">
          <radio value="{{item.id}}" />
          <text class="reason-text">{{item.text}}</text>
        </label>
      </radio-group>

      <textarea
        class="reason-textarea"
        placeholder="è¯·è¾“å…¥å…¶ä»–åŸå› ï¼ˆé€‰å¡«ï¼‰"
        value="{{cancelForm.reason}}"
        bindinput="onCancelReasonInput"
        maxlength="200"
      />
      <text class="reason-count">{{cancelForm.reason.length}}/200</text>
    </view>

    <view class="cancel-footer">
      <button class="btn btn-outline" bindtap="onCancelModalClose">æš‚ä¸å–æ¶ˆ</button>
      <button
        class="btn btn-danger"
        bindtap="onConfirmCancel"
        disabled="{{!cancelForm.reasonId && !cancelForm.reason}}"
      >ç¡®è®¤å–æ¶ˆ</button>
    </view>
  </view>
</view>

<!-- è¯„ä»·å¼¹çª— -->
<view class="review-modal {{showReviewModal ? 'show' : ''}}" bindtap="onReviewModalClose">
  <view class="review-content" catchtap="onReviewModalContentTap">
    <view class="review-header">
      <text class="review-title">æœåŠ¡è¯„ä»·</text>
      <text class="review-close" bindtap="onReviewModalClose">Ã—</text>
    </view>

    <view class="review-body">
      <!-- æœåŠ¡ä¿¡æ¯ -->
      <view class="review-service-info" wx:if="{{reviewOrder}}">
        <image class="review-technician-avatar" src="{{reviewOrder.technician.avatar}}" mode="aspectFill" />
        <view class="review-service-details">
          <text class="review-service-name">{{reviewOrder.service.name}}</text>
          <text class="review-technician-name">{{reviewOrder.technician.name}}</text>
        </view>
      </view>

      <!-- è¯„åˆ† -->
      <view class="rating-section">
        <text class="rating-label">æœåŠ¡è¯„åˆ†</text>
        <view class="rating-stars">
          <text
            class="star {{index < reviewForm.rating ? 'filled' : ''}}"
            wx:for="{{[1,2,3,4,5]}}"
            wx:key="*this"
            bindtap="onRatingTap"
            data-rating="{{index + 1}}"
          >â˜…</text>
        </view>
        <text class="rating-text">{{getRatingText(reviewForm.rating)}}</text>
      </view>

      <!-- è¯„ä»·æ ‡ç­¾ -->
      <view class="review-tags">
        <text class="tags-label">å¿«é€Ÿæ ‡ç­¾</text>
        <view class="tags-list">
          <text
            class="tag-item {{reviewForm.tags.includes(item) ? 'selected' : ''}}"
            wx:for="{{reviewTags}}"
            wx:key="*this"
            bindtap="onTagTap"
            data-tag="{{item}}"
          >{{item}}</text>
        </view>
      </view>

      <!-- è¯„ä»·å†…å®¹ -->
      <view class="review-content-section">
        <text class="content-label">è¯„ä»·å†…å®¹</text>
        <textarea
          class="content-textarea"
          placeholder="åˆ†äº«æ‚¨çš„æœåŠ¡ä½“éªŒï¼Œå¸®åŠ©å…¶ä»–ç”¨æˆ·æ›´å¥½åœ°é€‰æ‹©..."
          value="{{reviewForm.content}}"
          bindinput="onReviewContentInput"
          maxlength="500"
        />
        <text class="content-count">{{reviewForm.content.length}}/500</text>
      </view>

      <!-- å›¾ç‰‡ä¸Šä¼  -->
      <view class="review-images">
        <text class="images-label">ä¸Šä¼ å›¾ç‰‡</text>
        <view class="images-grid">
          <view
            class="image-item"
            wx:for="{{reviewForm.images}}"
            wx:key="*this"
          >
            <image class="uploaded-image" src="{{item}}" mode="aspectFill" bindtap="onImagePreview" data-urls="{{reviewForm.images}}" data-current="{{item}}" />
            <view class="image-delete" bindtap="onDeleteImage" data-index="{{index}}">
              <text class="delete-icon">Ã—</text>
            </view>
          </view>
          <view class="image-upload" bindtap="onChooseImage" wx:if="{{reviewForm.images.length < 6}}">
            <text class="upload-icon">ğŸ“·</text>
            <text class="upload-text">æ·»åŠ å›¾ç‰‡</text>
          </view>
        </view>
      </view>
    </view>

    <view class="review-footer">
      <button class="btn btn-outline" bindtap="onReviewModalClose">ç¨åè¯„ä»·</button>
      <button
        class="btn btn-primary"
        bindtap="onSubmitReview"
        disabled="{{reviewForm.rating === 0}}"
      >æäº¤è¯„ä»·</button>
    </view>
  </view>
</view>

<!-- å›¾ç‰‡é¢„è§ˆ -->
<view class="image-preview-modal {{showImagePreview ? 'show' : ''}}" bindtap="onImagePreviewClose">
  <view class="preview-content" catchtap="onImagePreviewContentTap">
    <swiper
      class="preview-swiper"
      indicator-dots="{{previewImages.length > 1}}"
      current="{{previewIndex}}"
      bindchange="onPreviewChange"
    >
      <swiper-item wx:for="{{previewImages}}" wx:key="*this">
        <image class="preview-image" src="{{item}}" mode="aspectFit" />
      </swiper-item>
    </swiper>
    <text class="preview-close" bindtap="onImagePreviewClose">Ã—</text>
  </view>
</view>