<!-- åœ°å€ç®¡ç†é¡µé¢ -->
<view class="address-page">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="page-header">
    <text class="page-title">åœ°å€ç®¡ç†</text>
    <button class="add-btn" bindtap="onAddAddress">
      <text class="add-icon">+</text>
      <text class="add-text">æ–°å¢åœ°å€</text>
    </button>
  </view>

  <!-- åœ°å€åˆ—è¡¨ -->
  <scroll-view class="address-scroll" scroll-y="true" style="height: {{scrollHeight}}">
    <view class="address-list">
      <!-- å½“å‰ä½ç½® -->
      <view class="current-location-section">
        <view class="section-header">
          <text class="section-title">å½“å‰ä½ç½®</text>
          <view class="location-status {{locationLoading ? 'loading' : ''}}">
            <text class="status-text">{{locationLoading ? 'å®šä½ä¸­...' : 'ä½¿ç”¨æ­¤ä½ç½®'}}</text>
          </view>
        </view>

        <view class="current-location-item" bindtap="onUseCurrentLocation">
          <view class="location-icon-wrapper">
            <text class="location-icon">ğŸ“</text>
          </view>
          <view class="location-info">
            <text class="location-title">å½“å‰ä½ç½®</text>
            <text class="location-desc">{{currentLocation.address || 'æ­£åœ¨è·å–ä½ç½®ä¿¡æ¯...'}}</text>
            <view class="location-accuracy" wx:if="{{currentLocation.accuracy}}">
              <text class="accuracy-text">ç²¾åº¦çº¦{{currentLocation.accuracy}}ç±³</text>
            </view>
          </view>
          <view class="location-action">
            <text class="action-text">ä½¿ç”¨</text>
          </view>
        </view>
      </view>

      <!-- å·²ä¿å­˜åœ°å€ -->
      <view class="saved-addresses-section" wx:if="{{addressList.length > 0}}">
        <view class="section-header">
          <text class="section-title">å·²ä¿å­˜åœ°å€</text>
          <text class="section-count">({{addressList.length}})</text>
        </view>

        <view class="address-items">
          <view
            class="address-item {{item.isDefault ? 'default' : ''}}"
            wx:for="{{addressList}}"
            wx:key="id"
            bindtap="onSelectAddress"
            data-address="{{item}}"
          >
            <!-- é»˜è®¤æ ‡è¯† -->
            <view class="default-badge" wx:if="{{item.isDefault}}">
              <text class="badge-text">é»˜è®¤</text>
            </view>

            <!-- åœ°å€å†…å®¹ -->
            <view class="address-content">
              <view class="address-header">
                <view class="contact-info">
                  <text class="contact-name">{{item.name}}</text>
                  <text class="contact-phone">{{item.phone}}</text>
                </view>
                <view class="address-type">
                  <text class="type-icon">{{getAddressIcon(item.type)}}</text>
                  <text class="type-text">{{getAddressTypeText(item.type)}}</text>
                </view>
              </view>

              <text class="address-detail">{{item.fullAddress}}</text>

              <view class="address-note" wx:if="{{item.note}}">
                <text class="note-icon">ğŸ“</text>
                <text class="note-text">{{item.note}}</text>
              </view>

              <!-- è·ç¦»ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰ -->
              <view class="distance-info" wx:if="{{item.distance}}">
                <text class="distance-icon">ğŸš¶</text>
                <text class="distance-text">è·ç¦»å½“å‰ä½ç½® {{item.distance}}km</text>
              </view>
            </view>

            <!-- æ“ä½œæŒ‰é’® -->
            <view class="address-actions">
              <view class="action-item" bindtap="onEditAddress" data-address="{{item}}">
                <text class="action-icon">âœï¸</text>
                <text class="action-text">ç¼–è¾‘</text>
              </view>
              <view class="action-item" bindtap="onDeleteAddress" data-address="{{item}}">
                <text class="action-icon">ğŸ—‘ï¸</text>
                <text class="action-text">åˆ é™¤</text>
              </view>
            </view>

            <!-- é€‰æ‹©æŒ‡ç¤ºå™¨ -->
            <view class="select-indicator" wx:if="{{selectedAddressId === item.id}}">
              <text class="indicator-icon">âœ“</text>
            </view>
          </view>
        </view>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:if="{{addressList.length === 0 && !locationLoading}}">
        <text class="empty-icon">ğŸ“</text>
        <text class="empty-title">è¿˜æ²¡æœ‰ä¿å­˜çš„åœ°å€</text>
        <text class="empty-desc">æ·»åŠ å¸¸ç”¨åœ°å€ï¼Œå¿«é€Ÿé€‰æ‹©æœåŠ¡åœ°ç‚¹</text>
        <button class="btn btn-primary" bindtap="onAddAddress">
          æ·»åŠ ç¬¬ä¸€ä¸ªåœ°å€
        </button>
      </view>

      <!-- å¿«æ·æ“ä½œæç¤º -->
      <view class="tips-section" wx:if="{{addressList.length > 0}}">
        <view class="tips-header">
          <text class="tips-icon">ğŸ’¡</text>
          <text class="tips-title">ä½¿ç”¨æç¤º</text>
        </view>
        <view class="tips-list">
          <text class="tip-item">â€¢ é•¿æŒ‰åœ°å€å¯å¿«é€Ÿè®¾ä¸ºé»˜è®¤åœ°å€</text>
          <text class="tip-item">â€¢ ç‚¹å‡»åœ°å€å¯ç›´æ¥é€‰æ‹©ä½¿ç”¨</text>
          <text class="tip-item">â€¢ å»ºè®®æ·»åŠ å®¶åº­å’Œå·¥ä½œåœ°å€ï¼Œæ–¹ä¾¿å¿«é€Ÿé€‰æ‹©</text>
          <text class="tip-item">â€¢ å¼€å¯ä½ç½®æƒé™å¯è‡ªåŠ¨è·å–å½“å‰ä½ç½®</text>
        </view>
      </view>
    </view>
  </scroll-view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="bottom-bar" wx:if="{{showBottomActions}}">
    <button class="btn btn-outline" bindtap="onCancel">å–æ¶ˆ</button>
    <button
      class="btn btn-primary"
      bindtap="onConfirm"
      disabled="{{!selectedAddressId && !currentLocation.address}}"
    >
      ç¡®è®¤é€‰æ‹©
    </button>
  </view>

  <!-- å®‰å…¨åŒºåŸŸé€‚é… -->
  <view class="safe-area-bottom"></view>
</view>

<!-- åœ°å€ç¼–è¾‘å¼¹çª— -->
<view class="address-edit-modal {{showEditModal ? 'show' : ''}}" bindtap="onEditModalClose">
  <view class="edit-content" catchtap="onEditModalContentTap">
    <view class="edit-header">
      <text class="edit-title">{{editMode === 'add' ? 'æ–°å¢åœ°å€' : 'ç¼–è¾‘åœ°å€'}}</text>
      <text class="edit-close" bindtap="onEditModalClose">Ã—</text>
    </view>

    <scroll-view class="edit-body" scroll-y="true">
      <!-- åœ°å€ç±»å‹ -->
      <view class="form-group">
        <text class="form-label">åœ°å€ç±»å‹</text>
        <view class="type-selector">
          <view
            class="type-option {{editForm.type === 'home' ? 'selected' : ''}}"
            bindtap="onTypeSelect"
            data-type="home"
          >
            <text class="type-icon">ğŸ </text>
            <text class="type-text">å®¶</text>
          </view>
          <view
            class="type-option {{editForm.type === 'company' ? 'selected' : ''}}"
            bindtap="onTypeSelect"
            data-type="company"
          >
            <text class="type-icon">ğŸ¢</text>
            <text class="type-text">å…¬å¸</text>
          </view>
          <view
            class="type-option {{editForm.type === 'other' ? 'selected' : ''}}"
            bindtap="onTypeSelect"
            data-type="other"
          >
            <text class="type-icon">ğŸ“</text>
            <text class="type-text">å…¶ä»–</text>
          </view>
        </view>
      </view>

      <!-- è”ç³»äºº -->
      <view class="form-group">
        <text class="form-label required">è”ç³»äºº</text>
        <input
          class="form-input"
          type="text"
          placeholder="è¯·è¾“å…¥è”ç³»äººå§“å"
          value="{{editForm.name}}"
          bindinput="onNameInput"
          maxlength="20"
        />
      </view>

      <!-- ç”µè¯å·ç  -->
      <view class="form-group">
        <text class="form-label required">ç”µè¯å·ç </text>
        <input
          class="form-input"
          type="number"
          placeholder="è¯·è¾“å…¥ç”µè¯å·ç "
          value="{{editForm.phone}}"
          bindinput="onPhoneInput"
          maxlength="11"
        />
      </view>

      <!-- åœ°åŒºé€‰æ‹© -->
      <view class="form-group">
        <text class="form-label required">æ‰€åœ¨åœ°åŒº</text>
        <picker
          mode="region"
          value="{{editForm.region}}"
          bindchange="onRegionChange"
        >
          <view class="picker-view">
            <text class="picker-text">{{editForm.region.join('') || 'è¯·é€‰æ‹©çœå¸‚åŒº'}}</text>
            <text class="picker-arrow">â–¼</text>
          </view>
        </picker>
      </view>

      <!-- è¯¦ç»†åœ°å€ -->
      <view class="form-group">
        <text class="form-label required">è¯¦ç»†åœ°å€</text>
        <textarea
          class="form-textarea"
          placeholder="è¯·è¾“å…¥è¯¦ç»†åœ°å€ï¼ˆè¡—é“ã€é—¨ç‰Œå·ç­‰ï¼‰"
          value="{{editForm.detailAddress}}"
          bindinput="onDetailAddressInput"
          maxlength="100"
        />
      </view>

      <!-- åœ°å›¾å®šä½ -->
      <view class="form-group">
        <text class="form-label">ä½ç½®å®šä½</text>
        <view class="location-selector" bindtap="onLocationSelect">
          <view class="location-info" wx:if="{{editForm.location}}">
            <text class="location-coords">{{editForm.location.latitude}}, {{editForm.location.longitude}}</text>
            <text class="location-desc">{{editForm.location.address}}</text>
          </view>
          <text class="location-placeholder" wx:else>ç‚¹å‡»åœ°å›¾é€‰æ‹©ä½ç½®</text>
          <text class="location-arrow">></text>
        </view>
      </view>

      <!-- å¤‡æ³¨ -->
      <view class="form-group">
        <text class="form-label">å¤‡æ³¨ä¿¡æ¯</text>
        <textarea
          class="form-textarea"
          placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯ï¼ˆé€‰å¡«ï¼‰"
          value="{{editForm.note}}"
          bindinput="onNoteInput"
          maxlength="50"
        />
        <text class="form-count">{{editForm.note.length}}/50</text>
      </view>

      <!-- è®¾ä¸ºé»˜è®¤ -->
      <view class="form-group">
        <checkbox-group bindchange="onDefaultChange">
          <label class="checkbox-label">
            <checkbox value="default" checked="{{editForm.isDefault}}" />
            <text class="checkbox-text">è®¾ä¸ºé»˜è®¤åœ°å€</text>
          </label>
        </checkbox-group>
      </view>
    </scroll-view>

    <view class="edit-footer">
      <button class="btn btn-outline" bindtap="onEditModalClose">å–æ¶ˆ</button>
      <button class="btn btn-primary" bindtap="onSaveAddress">ä¿å­˜</button>
    </view>
  </view>
</view>

<!-- åœ°å›¾é€‰æ‹©å¼¹çª— -->
<view class="map-selector-modal {{showMapModal ? 'show' : ''}}" bindtap="onMapModalClose">
  <view class="map-content">
    <view class="map-header">
      <text class="map-title">é€‰æ‹©ä½ç½®</text>
      <view class="map-actions">
        <text class="map-action" bindtap="onCurrentLocationMap">å®šä½å½“å‰ä½ç½®</text>
        <text class="map-close" bindtap="onMapModalClose">Ã—</text>
      </view>
    </view>

    <!-- åœ°å›¾å®¹å™¨ -->
    <map
      class="map-container"
      latitude="{{mapCenter.latitude}}"
      longitude="{{mapCenter.longitude}}"
      scale="16"
      show-location="{{true}}"
      bindtap="onMapTap"
      bindmarkertap="onMarkerTap"
    >
      <!-- å½“å‰ä½ç½®æ ‡è®° -->
      <cover-view class="current-marker" wx:if="{{selectedLocation}}">
        <cover-view class="marker-icon">ğŸ“</cover-view>
      </cover-view>
    </map>

    <!-- åœ°å€ä¿¡æ¯ -->
    <view class="map-address-info" wx:if="{{selectedLocation.address}}">
      <text class="map-address">{{selectedLocation.address}}</text>
    </view>

    <!-- ç¡®è®¤æŒ‰é’® -->
    <view class="map-footer">
      <button class="btn btn-outline" bindtap="onMapModalClose">å–æ¶ˆ</button>
      <button class="btn btn-primary" bindtap="onMapConfirm">ç¡®è®¤ä½ç½®</button>
    </view>
  </view>
</view>

<!-- åˆ é™¤ç¡®è®¤å¼¹çª— -->
<view class="delete-modal {{showDeleteModal ? 'show' : ''}}" bindtap="onDeleteModalClose">
  <view class="delete-content" catchtap="onDeleteModalContentTap">
    <view class="delete-header">
      <text class="delete-icon">âš ï¸</text>
      <text class="delete-title">ç¡®è®¤åˆ é™¤åœ°å€ï¼Ÿ</text>
    </view>

    <view class="delete-body">
      <text class="delete-desc">åˆ é™¤åæ— æ³•æ¢å¤ï¼Œè¯·è°¨æ…æ“ä½œ</text>
      <view class="delete-address-preview" wx:if="{{deleteTargetAddress}}">
        <text class="preview-name">{{deleteTargetAddress.name}}</text>
        <text class="preview-address">{{deleteTargetAddress.fullAddress}}</text>
      </view>
    </view>

    <view class="delete-footer">
      <button class="btn btn-outline" bindtap="onDeleteModalClose">å–æ¶ˆ</button>
      <button class="btn btn-danger" bindtap="onConfirmDelete">ç¡®è®¤åˆ é™¤</button>
    </view>
  </view>
</view>

<!-- é•¿æŒ‰èœå• -->
<view class="long-press-menu {{showLongPressMenu ? 'show' : ''}}" bindtap="onLongPressMenuClose">
  <view class="menu-content" catchtap="onMenuContentTap">
    <view class="menu-item" bindtap="onSetDefault" wx:if="{{!longPressAddress.isDefault}}">
      <text class="menu-icon">â­</text>
      <text class="menu-text">è®¾ä¸ºé»˜è®¤</text>
    </view>
    <view class="menu-item" bindtap="onEditFromMenu">
      <text class="menu-icon">âœï¸</text>
      <text class="menu-text">ç¼–è¾‘åœ°å€</text>
    </view>
    <view class="menu-item danger" bindtap="onDeleteFromMenu">
      <text class="menu-icon">ğŸ—‘ï¸</text>
      <text class="menu-text">åˆ é™¤åœ°å€</text>
    </view>
  </view>
</view>